# 鸣潮角色练度查询功能说明

## 功能概述

本插件为 nonebot_plugin_wwuid 添加了完整的角色练度查询功能，包括：
- 批量刷新角色数据
- 单角色详情查询
- 角色练度统计和排行
- 角色列表查看

## 使用前准备

### 1. 绑定游戏账号

在使用角色练度查询功能前，需要先绑定游戏账号：

```
/添加ck <游戏UID> <CK>
```

示例：
```
/添加ck 123456789 your_cookie_here
```

### 2. 刷新角色数据

首次使用需要刷新角色数据：

```
/刷新面板
```

## 命令说明

### 刷新命令

#### 刷新所有角色
```
/刷新面板
/刷新全部
/refreshall
```
功能：批量获取所有角色的最新数据

#### 刷新单个角色
```
/刷新 <角色名>
/刷新角色 <角色名>
/refresh <角色名>
```
示例：
```
/刷新 忌炎
```

### 查询命令

#### 查询角色详情
```
/角色面板 <角色名>
/查询角色 <角色名>
/role <角色名>
/char <角色名>
```
示例：
```
/角色面板 忌炎
```

返回信息包括：
- 角色基础信息（等级、突破、命座）
- 武器信息（名称、等级、精炼）
- 声骸信息（已装备声骸列表）
- 技能等级（所有技能）

#### 查看角色列表
```
/角色列表
/我的角色
/myroles
```
功能：显示所有已拥有的角色及其基础信息

### 统计命令

#### 练度排行榜
```
/练度统计 [数量]
/练度排行 [数量]
/rank [数量]
```
示例：
```
/练度统计 10
```
功能：按综合评分显示角色练度排行榜

#### 练度汇总
```
/练度汇总
/角色汇总
/summary
```
功能：显示整体练度情况，包括：
- 角色总数
- 平均评分
- 高/中/低练度角色数量
- 最强和最弱角色

## 评分系统

综合评分基于以下维度：

| 维度 | 权重 | 说明 |
|------|------|------|
| 等级 | 25% | 角色等级 + 突破状态 |
| 命座 | 20% | 已解锁命座数量 |
| 武器 | 20% | 武器等级 + 突破状态 |
| 声骸 | 20% | 声骸数量 + 品质 |
| 技能 | 15% | 技能平均等级 |

## 支持的角色

目前支持以下角色查询：

- 忌炎 (1403)
- 吟霖 (1402)
- 今汐 (1101)
- 长离 (1503)
- 椿 (1502)
- 炽霞 (1301)
- 安可 (1303)
- 鸣徽 (1506)
- 白芷 (1202)
- 维里奈 (1201)
- 卡卡罗 (1501)
- 莫特斐 (1504)
- 莉维娅 (1505)
- 凌阳 (1601)
- 相里要 (1602)

更多角色可以继续在 `utils.py` 的 `ROLE_NAME_MAP` 中添加。

## 缓存机制

- 角色数据会缓存到本地文件 (`data/waves_cache/`)
- 默认缓存时间为 60 分钟
- 使用刷新命令可以强制更新缓存

## 错误处理

常见错误及解决方法：

| 错误 | 原因 | 解决方法 |
|------|------|----------|
| 未绑定游戏账号 | 未使用 `/添加ck` 绑定 | 先绑定游戏账号 |
| CK已失效 | Cookie 过期 | 使用 `/添加ck` 重新绑定 |
| 未找到角色信息 | 未刷新数据 | 使用 `/刷新面板` 刷新 |
| 未找到角色: xxx | 角色名错误 | 检查角色名称拼写 |

## 配置说明

可以在插件配置中自定义以下参数：

```python
# 缓存过期时间（分钟）
CACHE_EXPIRE_MINUTES = 60

# 刷新间隔限制（秒）
MAX_REFRESH_INTERVAL = 300

# 统计排行榜显示数量
STATISTICS_TOP_N = 10

# 评分权重配置
SCORE_WEIGHT_LEVEL = 25.0      # 等级权重
SCORE_WEIGHT_CHAIN = 20.0      # 命座权重
SCORE_WEIGHT_WEAPON = 20.0     # 武器权重
SCORE_WEIGHT_PHANTOM = 20.0    # 声骸权重
SCORE_WEIGHT_SKILL = 15.0     # 技能权重
```

## 技术架构

### 核心模块

1. **waves_api.py** - API 请求适配器
   - 封装鸣潮 API 调用
   - 处理请求头和认证
   - 统一响应格式

2. **models.py** - 数据模型
   - 角色数据模型（Pydantic）
   - 数据库模型（SQLAlchemy）
   - 数据验证和转换

3. **refresh.py** - 刷新管理器
   - 批量/单角色刷新
   - 数据缓存管理
   - 错误处理

4. **query.py** - 查询管理器
   - 角色详情查询
   - 角色列表查询
   - 格式化输出

5. **statistics.py** - 统计管理器
   - 评分计算
   - 排行生成
   - 汇总统计

6. **commands.py** - 命令处理
   - NoneBot 命令注册
   - 参数解析
   - 用户交互

7. **utils.py** - 工具函数
   - 角色名称映射
   - 缓存管理
   - 数据格式化

## 开发说明

### 添加新角色

在 `utils.py` 中的 `ROLE_NAME_MAP` 添加角色映射：

```python
ROLE_NAME_MAP: Dict[str, int] = {
    # 角色名: 角色ID
    "新角色名": 9999,
}
```

### 自定义评分权重

在 `config.py` 中修改权重配置，或在代码中动态调整：

```python
statistics_manager = get_statistics_manager()
statistics_manager.weight_config = {
    "level": 30.0,    # 提高等级权重
    "chain": 15.0,    # 降低命座权重
    "weapon": 20.0,
    "phantom": 20.0,
    "skill": 15.0,
}
```

### 扩展功能

可以基于现有架构扩展以下功能：
- 图片渲染（使用 nonebot_plugin_htmlrender）
- 历史练度对比
- 角色搭配建议
- 导出数据到 Excel
- 多账号支持

## 常见问题

### Q: 刷新面板很慢怎么办？

A: 首次刷新需要获取所有角色数据，比较慢。后续刷新会更快。可以单独刷新某个角色。

### Q: 评分不准确怎么办？

A: 评分权重可以在配置中调整。你可以根据自己的游戏理解自定义权重。

### Q: 如何导出数据？

A: 当前版本暂不支持导出，可以基于 `statistics.py` 的逻辑自行扩展。

### Q: 支持多个账号吗？

A: 当前版本每个用户只能绑定一个账号。如需多账号支持，需要修改数据库模型。

## 更新日志

### v1.0.0
- 初始版本
- 实现角色数据刷新
- 实现角色详情查询
- 实现练度统计和排行
- 支持文本格式输出

## 许可证

本插件遵循原项目的许可证。
